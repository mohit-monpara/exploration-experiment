# install.packages('plotly')
# install.packages('leaflet')
# install.packages('dplyr')
# install.packages('readr')
# install.packages('wordcloud')
# install.packages('ECharts2Shiny')
# install.packages('ggplot2')
# install.packages('wordcloud2')
# install.packages('shinythemes')


library(leaflet)  # used for plotting the map
library(shiny)   # Used for shiny app
library(dplyr)   # used for data manipulation
library(readr)  # used for reading rectangular data faster(eg. csv)
library(ECharts2Shiny)  # used for interactive charts
library(plotly) # used for making ineractive plots
library(wordcloud2)  # used for visualising Word Cloud
library(shinythemes) # Used for main theme of Shiny Application



# mydata <- data.frame(read.csv('data_0.csv'))
mydata <- data.frame(read.csv('data_sample.csv'))
mydata1 <- mydata[,  c("Date","Block","Description", "Location.Description","Primary.Type",
                       "District","Year","Domestic", "Arrest" )]



## The User Interface element in shiny
ui <- fluidPage(
  titlePanel(""),
  navbarPage(
    title = tags$u("Crime@Chicago"),   # Title of the Page
    theme = shinytheme("cerulean"),
    
    # The Welcome tab
    tabPanel("Welcome ",
             mainPanel(
               div(
                 style = "margin-left: 15%;",
                 br(),
                 br(),
                 h3(strong("Crime in Chicago visualisation App"), style = "margin-top:0"),
                 br(),
                 p(
                   "The following shiny app helps in visualising the trend in crimes in Chicago"
                 ),
                 br(),
                 h4(strong("Abstract")),
                 p(
                   "The Crimes - 2001 to present is a dataset that basically reflects incidents of crimes in the city of Chicago from since 2001. 
                   These are reported incidents extracted from the CLEAR (Citizen Law Enforcement Analysis and Reporting) system of the police department. "
                 ),
                 br(),
                 h4(strong("About Data")),
                 p(
                   "The dataset contains some 6.3 million rows of reported crimes, 
                   classified on the basis of type, location, time, etc. 22 such columns.  "
                 ),
                 br(),
                 h4(strong("Data Source")),
                 p(
                   "The data was obtained from the",
                   a("Crime Data set",
                     href = "https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2")
                 ),
                 br(),
                 p("Explore Various trends by clicking the tabs above"),
                 br()
                 )
               )),
    
    
    # The Map Tab in navigation bar
    # The map tab gives the location of crime in the area with detailed information of that crime
    tabPanel("Map",
             sidebarLayout(
               sidebarPanel(
                 selectInput('select_year_input_map',
                             'Select Year',
                             choices = c(sort(unique(mydata$Year), decreasing = FALSE)),
                             selected = 2001, 
                             multiple = TRUE),
                 hr(),
                 selectInput('select_district_input_map',
                             'Select District',
                             choices = c(sort(unique(mydata$District), decreasing = FALSE)),
                             selected = 1,
                             multiple = TRUE),
                 hr()
               ),
               mainPanel(
                 leafletOutput('map')
               )
             )
    ),
    
    
    # The analysis tab in the navigation bar
    tabPanel("Analysis",
             sidebarLayout(
               sidebarPanel(style = "position: fixed;width: 300px;",
                            selectInput('select_year_input_analysis',
                                        'Select Year',
                                        choices = c(sort(unique(mydata$Year), decreasing = FALSE)),
                                        selected = 2001, 
                                        multiple = TRUE),
                            hr(),
                            selectInput('select_district_input_analysis',
                                        'Select District',
                                        choices = c(sort(unique(mydata$District), decreasing = FALSE)),
                                        selected = 1,
                                        multiple = TRUE),
                            hr()
               ),
               
               # the main panel displays the output generated by the server
               mainPanel(
                 tabPanel("Bar Plot", plotOutput('bar_op_monthly')), ## Displays the bar plot
                 div(
                   style = "margin-left: 15%;",
                   
                   ##Split the main panel to display two plots
                   fluidRow(
                     splitLayout(cellWidths = c("50%", "50%"), plotOutput('bar_op_hourly_day'), plotOutput('bar_op_hourly_night'))
                   ),
                   plotOutput('boxplot_op'),
                   
                   ###Split the main panel to display two plots
                   fluidRow(
                     splitLayout(cellWidths = c("50%", "50%"), plotOutput('bar_top_primary_type_op'),plotOutput('bar_top_location_op'))
                   ),
                   
                   
                   plotOutput('bar_dangerous_time_op')
                 )
               )
             )
    ),
    
    
    # The word cloud tab in the navigation bar
    tabPanel("Word Cloud",
             sidebarLayout(
               sidebarPanel(
                 selectInput('select_year_input_wc',
                             'Select Year',
                             choices = c(sort(unique(mydata$Year), decreasing = FALSE)),
                             selected = 2001, 
                             multiple = TRUE),
                 hr(),
                 selectInput('select_district_input_wc',
                             'Select District',
                             choices = c(sort(unique(mydata$District), decreasing = FALSE)),
                             selected = 1,
                             multiple = TRUE),
                 hr(),
                 
                 # the radio buttons helps to select the different options for the word cloud
                 radioButtons("wc_radio_button", label = h3("Select the Wordcloud type"),
                              choices = list("Primary Type"=1, "Location Description"=2),
                              selected = 1)
               ),
               
               ## Displays the word cloud depending upon the user selection
               mainPanel(
                 # h4(strong("Word Cloud")),
                 wordcloud2Output('plot_wordcloud')
               )
             )
    ),
    
    
    # The data tab in the navigation bar
    tabPanel("Data",
             sidebarLayout(
               sidebarPanel(
                 selectInput('select_year_input_data',
                             'Select Year',
                             choices = c(sort(unique(mydata$Year), decreasing = FALSE)),
                             selected = 2001, 
                             multiple = TRUE),
                 hr(),
                 selectInput('select_district_input_data',
                             'Select District',
                             choices = c(sort(unique(mydata$District), decreasing = FALSE)),
                             selected = 1,
                             multiple = TRUE),
                 hr()
               ),
               
               
               mainPanel(
                 textOutput("selection"),
                 dataTableOutput("table")
               )
             )
    ),
    
    
    # The overall analysis tab in the navigation bar
    tabPanel("Overall Analysis",
             fluidPage(
               mainPanel(
                 tabsetPanel(
                   tabPanel("Line Graph", plotOutput('overall_line_yearly')), 
                   tabPanel("Map", leafletOutput('map_overall')), 
                   tabPanel("Primary Crime", h4(strong("Word Cloud For Overall Primary Crime")),wordcloud2Output('plot_wordcloud_overall')),
                   tabPanel("Affected Location", h4(strong("Word Cloud For Overall Affected Locations")), wordcloud2Output('plot_wordcloud_overall_dang_loc'))
                 )
               )
             )
    )
  )
  )



server <- function(input, output){
  
  output$table <- renderDataTable({
    year_val <- input$select_year_input_data  ## Assign the values from user input for year to a variable
    dis <- input$select_district_input_data   ## Assign the values from user input for district to a variable
    subset_df <- mydata1[mydata1$Year %in% year_val & mydata1$District %in% dis,]  # subsetting the dataframe according to user selection
    subset_df
  } , options = list(
    pageLength = 5))
  
  
  # Plot the map according to the input values
  output$map <- renderLeaflet({
    year_val <- input$select_year_input_map ## Assign the values from user input for year to a variable
    dis <- input$select_district_input_map ## Assign the values from user input for district to a variable
    subset_df <- mydata[mydata$Year %in% year_val & mydata$District %in% dis,] # subsetting the dataframe according to user selection
    subset_df <- subset_df[!with(subset_df,is.na(Latitude)& is.na(Longitude)),] ## Removing NA values(if have)
    
    #plot the map using leaflet
    leaflet(data = subset_df) %>% addTiles() %>% 
      addMarkers(
        clusterOptions = markerClusterOptions(showCoverageOnHover = TRUE, zoomToBoundsOnClick = TRUE,
                                              spiderfyOnMaxZoom = TRUE, removeOutsideVisibleBounds = TRUE,
                                              spiderLegPolylineOptions = list(weight = 2, color = "#100", opacity =
                                                                                1), freezeAtZoom = FALSE),
        
        popup = paste("Date:", subset_df$Date, "<br>",
                      "Primary Type: ", subset_df$Primary.Type, "<br>",
                      "Description: ", subset_df$Description, "<br>",
                      "Arrest: ", subset_df$Arrest, "<br>",
                      "Block:", subset_df$Block,"<br>",
                      "Location: ", subset_df$Location.Description,"<br>",
                      "District:", subset_df$District,"<br>",
                      "Year:", subset_df$Year),
        
        options = popupOptions(minWidth = 20, closeOnClick = FALSE, closeButton = FALSE)
        
        
      )
  })
  
  
  # code for the barplot for monthly crimes
  output$bar_op_monthly <- renderPlot({
    year_val <- input$select_year_input_analysis  ## Assign the values from user input for year to a variable
    dis <- input$select_district_input_analysis   ## Assign the values from user input for district to a variable
    subset_df <- mydata[mydata$Year %in% year_val & mydata$District %in% dis,] ## Subsetting the data
    
    bar_op_monthly_plot = table(subset_df$Month)
    barplot(bar_op_monthly_plot, beside = FALSE, 
            main = 'Monthly Crime Rate', xlab = "Month", ylab = "No. of Incidents", col = "blue",
            density=10)
  })
  
  # Code for bar plot for hourly crime on day time
  output$bar_op_hourly_day <- renderPlot({
    year_val <- input$select_year_input_analysis    ## Assign the values from user input for year to a variable
    dis <- input$select_district_input_analysis     ## Assign the values from user input for district to a variable
    day_time_a <- 'A'                               ## Assign the range of time zone to a variable
    day_time_d <- 'D'                               ## Assign the range of time zone to a variable
    subset_df <- mydata[mydata$Year %in% year_val & mydata$District %in% dis,]
    subset_day <- subset_df[subset_df$Range %in% day_time_a | subset_df$Range %in% day_time_d,]
    abc = table(subset_day$Month)
    barplot(abc, beside = FALSE, main = 'Crime Rate At Day-Time', xlab = "Month", ylab = "No. of Incidents", col = "red")
    
  })
  
  
  # Code for bar plot for hourly crime on night time
  output$bar_op_hourly_night <- renderPlot({
    dd <- input$select_year_input_analysis  ## Assign the values from user input for year to a variable
    night_time_b <- 'B'                     ## Assign the range of time zone to a variable
    night_time_c <- 'C'                     ## Assign the range of time zone to a variable
    dis <- input$select_district_input_analysis    ## Assign the values from user input for district to a variable
    subset_df <- mydata[mydata$Year %in% dd & mydata$District %in% dis,]
    subset_night <- subset_df[subset_df$Range %in% night_time_b | subset_df$Range %in% night_time_c,]
    abc = table(subset_night$Month)
    barplot(abc, beside = FALSE, main = 'Crime Rate At Night-Time', xlab = "Month", ylab = "No. of Incidents", col = "red")
  })
  
  
  
  # Code for box plot
  output$boxplot_op <- renderPlot({
    dis <- input$select_district_input_analysis         ## Assign the values from user input for district to a variable
    dd <- input$select_year_input_analysis              ## Assign the values from user input for year to a variable
    subset_df <- mydata[mydata$Year %in% dd & mydata$District %in% dis,]
    boxplot(subset_df$ID~subset_df$Arrest, data=subset_df,
            main=toupper("Number of Arrest"), font.main=3, xlab="Arrest", ylab="No. of Incidents", font.lab=3, col=c("red","blue"), main = "Monthly Crime",
            horizontal = TRUE)
  })
  
  
  # Code for bar plot for hourly crime on night time
  output$bar_top_primary_type_op <- renderPlot({
    year_val <- input$select_year_input_analysis     ## Assign the values from user input for year to a variable
    dis <- input$select_district_input_analysis      ## Assign the values from user input for district to a variable
    subset_df <- mydata[mydata$Year %in% year_val & mydata$District %in% dis,]
    
    bar_top_primary_type = table(subset_df$Primary.Type)            ## making table from dataframe
    bar_top_primary_type = data.frame(bar_top_primary_type)
    bar_top_primary_type_decreasing <- bar_top_primary_type[order(bar_top_primary_type$Freq, decreasing = TRUE),][1:10,]  ## Assign top 10 values of primary type incidents
    barplot( bar_top_primary_type_decreasing$Freq,names.arg = bar_top_primary_type_decreasing$Var1,
             beside = FALSE, main = 'Top Crimes', 
             xlab = "Primary Type", ylab = "No. of Incidents", col = "red", cex.names=.7, width = 0.2)
  })
  
  
  
  # Code for bar plot for incidents occuring at top locations
  output$bar_top_location_op <- renderPlot({
    year_val <- input$select_year_input_analysis   ## Assign the values from user input for year to a variable
    dis <- input$select_district_input_analysis    ## Assign the values from user input for district to a variable
    subset_df <- mydata[mydata$Year %in% year_val & mydata$District %in% dis,]
    bar_top_location <- data.frame(table(subset_df$Location.Description))
    bar_top_location_decreasing <- bar_top_location[order(bar_top_location$Freq, decreasing = TRUE),][1:10,] ## Assign top 10 values of primary location incidents
    barplot( bar_top_location_decreasing$Freq,names.arg = bar_top_location_decreasing$Var1,
             beside = TRUE, main = 'Top Crime Location', xlab = "Crime Location", 
             ylab = "No. of Incidents", col = "green", width=0.2, cex.names=0.7)
  })
  
  
  # Code for bar plot for incidents occuring at top locations
  output$bar_dangerous_time_op <- renderPlot({
    year_val <- input$select_year_input_analysis     ## Assign the values from user input for year to a variable
    dis <- input$select_district_input_analysis     ## Assign the values from user input for year to a variable
    subset_df <- mydata[mydata$Year %in% year_val & mydata$District %in% dis,]
    bar_dangerous_time <- table(subset_df$Range)
    barplot(bar_dangerous_time, beside = TRUE, main = 'Dangerous Time', xlab = "Time Phase", ylab = "No. of Incidents", col = "red", width=1)
    
  })
  
  
  # Code for word cloud for incidents occuring at top locations
  output$plot_wordcloud <- renderWordcloud2({
    
    # code for wordcloud for primary types
    if (input$wc_radio_button == 1){
      year_val <- input$select_year_input_wc    ## Assign the values from user input for year to a variable
      dis <- input$select_district_input_wc     ## Assign the values from user input for district to a variable
      subset_df <- mydata[mydata$Year %in% year_val & mydata$District %in% dis,]
      word_cloud <- count(subset_df, Primary.Type)  # Count the frequency of each primary type
      
      wordcloud2(word_cloud, size = 0.5,
                 minSize = 0, gridSize =  0,
                 fontFamily = 'Arial', fontWeight = 'bold',
                 color = 'random-dark', backgroundColor = "Black",
                 minRotation = -pi, maxRotation = pi/4, shuffle = TRUE,
                 rotateRatio = 0.4, shape = 'square', ellipticity = 0.65,
                 widgetsize = NULL, figPath = NULL, hoverFunction = NULL)
    }
    else
    {
      # code for wordcloud for primary locations
      year_val <- input$select_year_input_wc
      dis <- input$select_district_input_wc
      subset_df <- mydata[mydata$Year %in% year_val & mydata$District %in% dis,]
      word_cloud <- count(subset_df, Location.Description)      # Count the frequency of each location
      wordcloud2(word_cloud, size = 0.5,
                 minSize = 0, gridSize =  0,
                 fontFamily = 'Arial', fontWeight = 'bold',
                 color = 'random-dark', backgroundColor = "Black",
                 minRotation = -pi/4, maxRotation = pi/4, shuffle = TRUE,
                 rotateRatio = 0.4, shape = 'square', ellipticity = 0.65,
                 widgetsize = NULL, figPath = NULL, hoverFunction = NULL)
    }
  })
  
  
  # Code for line graph for overall incidents
  output$overall_line_yearly <- renderPlot({
    abc = table(mydata$Year)
    plot(abc, type = "o", 
         # main = "Overall Trend Of Crime Over years", 
         xlab = "Years", 
         ylab = "Count of Incidents", col = 'Red')
    title(main = "Overall Trend Of Crime Over years", col.main = "Black", font.main=10)
  })
  
  
  #Displays overall wordcloud for Primary type
  output$plot_wordcloud_overall <- renderWordcloud2({
    word_cloud_full <- count(mydata, Primary.Type)    # Count the frequency of each primary type
    wordcloud2(word_cloud_full, size = 0.5,
               minSize = 0, gridSize =  0,
               fontFamily = 'Arial', fontWeight = 'bold',
               color = 'random-dark', backgroundColor = "Black",
               minRotation = -pi/4, maxRotation = pi/4, shuffle = TRUE,
               rotateRatio = 0.4, shape = 'square', ellipticity = 0.65,
               widgetsize = NULL, figPath = NULL, hoverFunction = NULL )
    
  })
  
  #Displays overall wordcloud for Locations
  output$plot_wordcloud_overall_dang_loc <- renderWordcloud2({
    word_cloud_full <- count(mydata, Location.Description) # Count the frequency of each location
    wordcloud2(word_cloud_full, size = 0.5,
               minSize = 0, gridSize =  0,
               fontFamily = 'Arial', fontWeight = 'bold',
               color = 'random-dark', backgroundColor = "Black",
               minRotation = -pi/4, maxRotation = pi/4, shuffle = TRUE,
               rotateRatio = 0.4, shape = 'square', ellipticity = 0.65,
               widgetsize = NULL, figPath = NULL, hoverFunction = NULL )
    
  })
  
  # #Displays overall map 
  output$map_overall <- renderLeaflet({
    mydata <- mydata[!with(mydata,is.na(Latitude)& is.na(Longitude)),]
    leaflet(data = mydata) %>% addTiles() %>% 
      addMarkers(
        clusterOptions = markerClusterOptions(showCoverageOnHover = TRUE, zoomToBoundsOnClick = TRUE,
                                              spiderfyOnMaxZoom = TRUE, removeOutsideVisibleBounds = TRUE,
                                              spiderLegPolylineOptions = list(weight = 2, color = "#100", 
                                                                              opacity = 1), freezeAtZoom = FALSE),
        
        popup = paste("Date:", mydata$Date, "<br>",
                      "Primary Type: ", mydata$Primary.Type, "<br>",
                      "Description: ", mydata$Description, "<br>",
                      "Arrest: ", mydata$Arrest, "<br>",
                      "Block:", mydata$Block,"<br>",
                      "Location: ", mydata$Location.Description,"<br>",
                      "District:", mydata$District,"<br>",
                      "Year:", mydata$Year),
        
        options = popupOptions(minWidth = 20, closeOnClick = FALSE, closeButton = FALSE)
        
        
      )
  })
  
}

shinyApp(ui, server)

